<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barman Construction</title>
    <link rel="icon" type="image/png" href="img/tab-logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="style/style.css" rel="stylesheet">
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<!-- Navbar will load here -->
<div id="nav-placeholder"></div>

<!-- Overtime Settings Modal -->
<div class="modal fade" id="overtimeSettingsModal" tabindex="-1" aria-labelledby="overtimeSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="overtimeSettingsModalLabel">Overtime Payment Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Overtime Payment Rate</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="overtimeRateType" id="rateTypePercentage" value="percentage" checked>
                        <label class="form-check-label" for="rateTypePercentage">
                            Percentage of Daily Wage
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="overtimeRateType" id="rateTypeFixed" value="fixed">
                        <label class="form-check-label" for="rateTypeFixed">
                            Fixed Amount
                        </label>
                    </div>
                </div>
                
                <div id="percentageSettings">
                    <div class="mb-3">
                        <label class="form-label">Full Overtime (% of daily wage)</label>
                        <input type="number" class="form-control" id="fullOTPercentage" value="100" min="0" max="500">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Half Overtime (% of daily wage)</label>
                        <input type="number" class="form-control" id="halfOTPercentage" value="50" min="0" max="500">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quarter Overtime (% of daily wage)</label>
                        <input type="number" class="form-control" id="quarterOTPercentage" value="25" min="0" max="500">
                    </div>
                </div>
                
                <div id="fixedSettings" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Full Overtime (Fixed Amount ₹)</label>
                        <input type="number" class="form-control" id="fullOTFixed" value="500" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Half Overtime (Fixed Amount ₹)</label>
                        <input type="number" class="form-control" id="halfOTFixed" value="250" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quarter Overtime (Fixed Amount ₹)</label>
                        <input type="number" class="form-control" id="quarterOTFixed" value="125" min="0">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Default Overtime Calculation</label>
                    <select class="form-select" id="defaultOTCalculation">
                        <option value="include">Include in daily payment</option>
                        <option value="separate">Show as separate line item</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOvertimeSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="content p-1">
    <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-1 p-2">
            <h4 class="text-nowrap top-h">
            <span class="d-none d-lg-inline">Payments Daily Worker</span>
            </h4>
  </div>

        <!-- Filters Section -->
        <div class="fix-card mb-2 p-2">
            <div class="card-header">
                <h5 class="mb-0">Select Filters</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-1">
                        <label for="projectSelect" class="form-label">Project</label>
                        <select class="form-select" id="projectSelect">
                            <option value="">Select Project</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-1 d-none">
                        <label for="employeeTypeSelect" class="form-label">Employee Type</label>
                        <select class="form-select" id="employeeTypeSelect">
                            <option value="daily" selected>Daily Worker</option>
                            <option value="contract">Contract Basis</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2 mb-1 d-none">
                        <label for="designationSelect" class="form-label">Designation</label>
                        <select class="form-select" id="designationSelect">
                            <option value="">All Designations</option>
                        </select>
                    </div>

                    <div class="col-md-3 mb-1">
                        <label for="fromDate" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="fromDate">
                    </div>
                    
                    <div class="col-md-3 mb-1">
                        <label for="toDate" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="toDate">
                    </div>
                    
                    <div class="col-md-12 mb-1 mt-2 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="loadAttendanceData()">
                            <i class="fas fa-search"></i> Load
                        </button>
                        <button class="btn btn-success me-2" onclick="calculatePayment()" id="calculateBtn" disabled>
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                        <button class="btn btn-info me-2" onclick="showOvertimeSettings()" id="otSettingsBtn">
                            <i class="fas fa-clock"></i> OT Settings
                        </button>
                        <button class="btn btn-danger ms-2 d-none" onclick="downloadPDF()" id="pdfBtn" disabled>
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                        <button class="btn btn-warning ms-2" onclick="addExpenseManually()" id="addExpenseBtn" disabled>
                            <i class="fas fa-plus-circle"></i> Add Expense
                        </button>
                    </div>
                </div>
            
                <!-- Settings Section -->
                <div class="card-footer">
                    <div class="row mt-1">
                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="halfDayAsFullDay" onchange="toggleHalfDayCalculation()">
                                <label class="form-check-label" for="halfDayAsFullDay">
                                    Count Half Days as Full Days in Payment Calculation
                                </label>
                                <small class="form-text text-muted d-block">
                                    When enabled, half days will be counted as 1 full day instead of 0.5 days
                                </small>
                            </div>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="includeOvertime" checked onchange="toggleOvertimeInclusion()">
                                <label class="form-check-label" for="includeOvertime">
                                    Include Overtime in Payment Calculation
                                </label>
                                <small class="form-text text-muted d-block">
                                    When enabled, overtime hours will be added to employee payments
                                </small>
                            </div>
                            <div class="form-check form-switch mt-2 d-none">
                                <input class="form-check-input" type="checkbox" id="autoMarkUnmarked" checked onchange="toggleAutoMark()">
                                <label class="form-check-label" for="autoMarkUnmarked">
                                    Automatically count unmarked days as Absent
                                </label>
                                <small class="form-text text-muted d-block">
                                    Days without attendance marked will be calculated as Absent (0 days)
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-2 d-none" id="summaryCards">
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-primary border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Total Employees</h6>
                        <h6 id="totalEmployeesCount" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-success border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Present Days</h6>
                        <h6 id="totalPresentDays" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-danger border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Absent Days</h6>
                        <h6 id="totalAbsentDays" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-warning border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Total Payment</h6>
                        <h6 id="totalPaymentAmount" class="fw-bold mb-0">₹0</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overtime Summary Cards -->
        <div class="row mb-2 d-none" id="otSummaryCards">
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-info border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Full OT Count</h6>
                        <h6 id="fullOTCount" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-info border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Half OT Count</h6>
                        <h6 id="halfOTCount" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-info border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Quarter OT Count</h6>
                        <h6 id="quarterOTCount" class="fw-bold mb-0">0</h6>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-1">
                <div class="card border-start border-primary border-2 h-100">
                    <div class="card-body text-center text-md-start p-2 p-md-3">
                        <h6 class="card-title small mb-1">Total OT Amount</h6>
                        <h6 id="totalOTAmount" class="fw-bold mb-0">₹0</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Table -->
        <div class="">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Payment Calculation</h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="exportToExcel()" id="exportBtn" disabled>
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="downloadPDF()" id="pdfBtn2" disabled>
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 600px; font-size: 12px;">
                    <table class="table table-hover mb-0" id="paymentTable">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th>Employee Name</th>
                                <th>Designation</th>
                                <th>Salary/Day</th>
                                <!-- Date columns will be inserted here -->
                                <th class="text-center">Present Days</th>
                                <th class="text-center">OT Count</th>
                                <th class="text-end">OT Amount (₹)</th>
                                <th class="text-end">Total Payment (₹)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="paymentTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                        <tfoot class="bg-light" id="paymentTableFooter">
                            <!-- Footer row will be inserted here -->
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="loader text-center d-none mt-4 mb-4" id="loaderOverlay">
                <section class="loader">
                    <div class="slider" style="--i:0"></div>
                    <div class="slider" style="--i:1"></div>
                    <div class="slider" style="--i:2"></div>
                    <div class="slider" style="--i:3"></div>
                    <div class="slider" style="--i:4"></div>
                </section>
            </div>
        </div>

    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="js/firebaseconfig.js"></script>
<script src="js/all.js"></script>
<!-- Excel Export Library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const database = firebase.database();
    let currentUser = null;
    let currentUserRole = 'user';
    let allProjects = [];
    let selectedProjectId = null;
    let selectedEmployeeType = null;
    let fromDate = '';
    let toDate = '';
    let dateRange = [];
    let employees = [];
    let attendanceData = {};
    let paymentData = {};
    let halfDayAsFullDay = false;
    let autoMarkUnmarked = true;
    let includeOvertime = true;
    
    // Overtime settings
    let overtimeSettings = {
        rateType: 'percentage', // 'percentage' or 'fixed'
        percentage: {
            full: 100,
            half: 50,
            quarter: 25
        },
        fixed: {
            full: 500,
            half: 250,
            quarter: 125
        },
        calculationMethod: 'include' // 'include' or 'separate'
    };

    // Check authentication
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = "login.html";
        } else {
            currentUser = user;
            await initializePage();
        }
    });

    // Initialize page
    async function initializePage() {
        try {
            // Get user role
            const userSnapshot = await database.ref(`users/${currentUser.uid}`).once('value');
            const userData = userSnapshot.val();
            currentUserRole = userData?.role || 'user';

            // Load overtime settings from localStorage
            loadOvertimeSettings();

            // Set default dates (last 7 days)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('fromDate').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('toDate').value = today.toISOString().split('T')[0];

            // Load projects
            await loadProjects();

            // Setup event listeners
            setupEventListeners();

        } catch (error) {
            console.error("Error initializing page:", error);
            alert("Error loading page: " + error.message);
        }
    }

    // Load overtime settings from localStorage
    function loadOvertimeSettings() {
        const saved = localStorage.getItem('overtimeSettings');
        if (saved) {
            try {
                overtimeSettings = JSON.parse(saved);
            } catch (e) {
                console.error("Error loading overtime settings:", e);
            }
        }
    }

    // Save overtime settings to localStorage
    function saveOvertimeSettingsToStorage() {
        localStorage.setItem('overtimeSettings', JSON.stringify(overtimeSettings));
    }

    // Show overtime settings modal
    function showOvertimeSettings() {
        // Set current values in modal
        document.querySelector(`input[name="overtimeRateType"][value="${overtimeSettings.rateType}"]`).checked = true;
        
        document.getElementById('fullOTPercentage').value = overtimeSettings.percentage.full;
        document.getElementById('halfOTPercentage').value = overtimeSettings.percentage.half;
        document.getElementById('quarterOTPercentage').value = overtimeSettings.percentage.quarter;
        
        document.getElementById('fullOTFixed').value = overtimeSettings.fixed.full;
        document.getElementById('halfOTFixed').value = overtimeSettings.fixed.half;
        document.getElementById('quarterOTFixed').value = overtimeSettings.fixed.quarter;
        
        document.getElementById('defaultOTCalculation').value = overtimeSettings.calculationMethod;
        
        // Show/hide appropriate settings
        toggleRateTypeSettings();
        
        const modal = new bootstrap.Modal(document.getElementById('overtimeSettingsModal'));
        modal.show();
    }

    // Toggle rate type settings
    function toggleRateTypeSettings() {
        const rateType = document.querySelector('input[name="overtimeRateType"]:checked').value;
        if (rateType === 'percentage') {
            document.getElementById('percentageSettings').style.display = 'block';
            document.getElementById('fixedSettings').style.display = 'none';
        } else {
            document.getElementById('percentageSettings').style.display = 'none';
            document.getElementById('fixedSettings').style.display = 'block';
        }
    }

    // Save overtime settings
    function saveOvertimeSettings() {
        overtimeSettings.rateType = document.querySelector('input[name="overtimeRateType"]:checked').value;
        
        overtimeSettings.percentage = {
            full: parseFloat(document.getElementById('fullOTPercentage').value) || 100,
            half: parseFloat(document.getElementById('halfOTPercentage').value) || 50,
            quarter: parseFloat(document.getElementById('quarterOTPercentage').value) || 25
        };
        
        overtimeSettings.fixed = {
            full: parseFloat(document.getElementById('fullOTFixed').value) || 500,
            half: parseFloat(document.getElementById('halfOTFixed').value) || 250,
            quarter: parseFloat(document.getElementById('quarterOTFixed').value) || 125
        };
        
        overtimeSettings.calculationMethod = document.getElementById('defaultOTCalculation').value;
        
        saveOvertimeSettingsToStorage();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('overtimeSettingsModal'));
        modal.hide();
        
        // Recalculate if data is loaded
        if (employees.length > 0) {
            updateAllEmployeeTotals();
            showNotification('Overtime settings updated', 'success');
        }
    }

    // Setup event listeners for rate type toggle
    document.addEventListener('change', function(e) {
        if (e.target.name === 'overtimeRateType') {
            toggleRateTypeSettings();
        }
    });

    // Toggle overtime inclusion
    function toggleOvertimeInclusion() {
        includeOvertime = document.getElementById('includeOvertime').checked;
        if (employees.length > 0) {
            updateAllEmployeeTotals();
        }
    }

    // Load projects
    async function loadProjects() {
        try {
            const projectSelect = document.getElementById('projectSelect');
            
            if (currentUserRole === 'admin') {
                const snapshot = await database.ref('projects').once('value');
                const allProjectsData = snapshot.val();
                
                if (allProjectsData) {
                    allProjects = [];
                    Object.keys(allProjectsData).forEach(projectId => {
                        allProjects.push({
                            id: projectId,
                            name: allProjectsData[projectId].projectName || 'Unnamed Project'
                        });
                    });
                }
            } else {
                const userSnapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                const userData = userSnapshot.val();
                const userProjects = userData?.projects || {};
                
                allProjects = [];
                const projectIds = Object.keys(userProjects).filter(
                    projectId => userProjects[projectId] === true
                );
                
                for (const projectId of projectIds) {
                    const projectSnap = await database.ref(`projects/${projectId}`).once('value');
                    if (projectSnap.exists()) {
                        const projectData = projectSnap.val();
                        allProjects.push({
                            id: projectId,
                            name: projectData.projectName || 'Unnamed Project'
                        });
                    }
                }
            }

            projectSelect.innerHTML = '<option value="">Select Project</option>';
            allProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });

        } catch (error) {
            console.error("Error loading projects:", error);
        }
    }

    // Setup event listeners
    function setupEventListeners() {
        document.getElementById('projectSelect').addEventListener('change', async function(e) {
            selectedProjectId = e.target.value;
            if (selectedProjectId) {
                await loadDesignations();
            } else {
                clearDesignations();
            }
        });

        document.getElementById('employeeTypeSelect').addEventListener('change', function(e) {
            selectedEmployeeType = e.target.value;
        });
    }

    // Load designations for selected project
    async function loadDesignations() {
        try {
            const designationSelect = document.getElementById('designationSelect');
            designationSelect.innerHTML = '<option value="">All Designations</option>';
            
            if (!selectedProjectId) return;
            
            const snapshot = await database.ref(`employees/${selectedProjectId}`).once('value');
            const employeesData = snapshot.val();
            
            if (!employeesData) return;
            
            const designations = new Set();
            Object.values(employeesData).forEach(employee => {
                if (employee.designation) {
                    designations.add(employee.designation);
                }
            });
            
            designations.forEach(designation => {
                const option = document.createElement('option');
                option.value = designation;
                option.textContent = designation;
                designationSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error("Error loading designations:", error);
        }
    }

    function clearDesignations() {
        const designationSelect = document.getElementById('designationSelect');
        designationSelect.innerHTML = '<option value="">All Designations</option>';
    }

    function showLoader() {
        document.getElementById('loaderOverlay').classList.remove('d-none');
        document.getElementById('loaderOverlay').classList.add('d-flex');
    }

    function hideLoader() {
        document.getElementById('loaderOverlay').classList.remove('d-flex');
        document.getElementById('loaderOverlay').classList.add('d-none');
    }

    function toggleHalfDayCalculation() {
        halfDayAsFullDay = document.getElementById('halfDayAsFullDay').checked;
        if (employees.length > 0) {
            updateAllEmployeeTotals();
        }
    }

    function toggleAutoMark() {
        autoMarkUnmarked = document.getElementById('autoMarkUnmarked').checked;
        if (employees.length > 0) {
            updateAllEmployeeTotals();
        }
    }

    // Load attendance data
    async function loadAttendanceData() {
        try {
            selectedProjectId = document.getElementById('projectSelect').value;
            selectedEmployeeType = document.getElementById('employeeTypeSelect').value;
            fromDate = document.getElementById('fromDate').value;
            toDate = document.getElementById('toDate').value;
            
            if (!selectedProjectId) {
                alert('Please select a project');
                return;
            }
            
            if (!selectedEmployeeType) {
                alert('Please select employee type');
                return;
            }
            
            if (!fromDate || !toDate) {
                alert('Please select date range');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                alert('From date cannot be after to date');
                return;
            }
            
            showLoader();
            
            dateRange = generateDateRange(fromDate, toDate);
            
            await loadEmployees();
            await loadAttendanceForDateRange();
            
            displayPaymentTable();
            
            document.getElementById('calculateBtn').disabled = false;
            document.getElementById('pdfBtn').disabled = false;
            document.getElementById('pdfBtn2').disabled = false;
            
            hideLoader();
            
        } catch (error) {
            console.error("Error loading attendance data:", error);
            hideLoader();
            alert('Error loading attendance data: ' + error.message);
        }
    }

    function generateDateRange(fromDate, toDate) {
        const dates = [];
        const currentDate = new Date(fromDate);
        const endDate = new Date(toDate);
        
        while (currentDate <= endDate) {
            dates.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        return dates;
    }

    async function loadEmployees() {
        try {
            const snapshot = await database.ref(`employees/${selectedProjectId}`).once('value');
            const employeesData = snapshot.val();
            
            employees = [];
            if (employeesData) {
                Object.keys(employeesData).forEach(employeeId => {
                    const employee = employeesData[employeeId];
                    
                    if (employee.employeeType === selectedEmployeeType) {
                        
                        const selectedDesignation = document.getElementById('designationSelect').value;
                        if (!selectedDesignation || employee.designation === selectedDesignation) {
                            
                            employees.push({
                                id: employeeId,
                                ...employee
                            });
                        }
                    }
                });
            }
            
        } catch (error) {
            console.error("Error loading employees:", error);
            throw error;
        }
    }

    async function loadAttendanceForDateRange() {
        try {
            attendanceData = {};
            
            for (const date of dateRange) {
                const snapshot = await database.ref(`projects/${selectedProjectId}/attendance/${date}`).once('value');
                const dateAttendance = snapshot.val();
                
                if (dateAttendance) {
                    attendanceData[date] = dateAttendance;
                } else {
                    attendanceData[date] = {};
                }
            }
            
        } catch (error) {
            console.error("Error loading attendance:", error);
            throw error;
        }
    }

    // Display payment table
    function displayPaymentTable() {
        const tableBody = document.getElementById('paymentTableBody');
        const tableHead = document.querySelector('#paymentTable thead tr');
        
        tableBody.innerHTML = '';
        
        const dateColumns = dateRange.map(date => {
            const day = new Date(date).getDate();
            const month = new Date(date).toLocaleString('default', { month: 'short' });
            const dayName = new Date(date).toLocaleString('default', { weekday: 'short' });
            return `
                <th class="text-center">
                    <div>${day} ${month}</div>
                    <div class="text-muted small">${dayName}</div>
                </th>
            `;
        }).join('');
        
        const headerCells = tableHead.querySelectorAll('th');
        const afterSalaryCell = headerCells[2];
        
        const existingDateColumns = tableHead.querySelectorAll('.date-col');
        existingDateColumns.forEach(col => col.remove());
        
        afterSalaryCell.insertAdjacentHTML('afterend', dateColumns);
        
        employees.forEach(employee => {
            const row = createEmployeeRow(employee);
            tableBody.innerHTML += row;
        });
        
        document.getElementById('summaryCards').classList.remove('d-none');
        document.getElementById('otSummaryCards').classList.remove('d-none');
        updateAllEmployeeTotals();
    }

    // Calculate overtime amount for an employee
    function calculateOvertimeAmount(employee, overtimeType) {
        if (!includeOvertime) return 0;
        
        const salary = employee.salaryAmount || 0;
        
        if (overtimeSettings.rateType === 'percentage') {
            const percentage = overtimeSettings.percentage[overtimeType] || 0;
            return (salary * percentage) / 100;
        } else {
            return overtimeSettings.fixed[overtimeType] || 0;
        }
    }

    // Create employee row with overtime
    function createEmployeeRow(employee) {
        const salary = employee.salaryAmount || 0;
        
        const dateColumns = dateRange.map(date => {
            const attendance = attendanceData[date]?.[employee.id];
            const currentStatus = attendance?.status || '';
            
            let statusText = '';
            let statusClass = '';
            let otIcon = '';
            
            if (currentStatus === 'present') {
                statusText = 'P';
                statusClass = 'text-success fw-bold';
            } else if (currentStatus.startsWith('present+')) {
                const overtime = currentStatus.split('+')[1];
                statusText = 'P';
                statusClass = 'text-primary fw-bold';
                otIcon = `<span class="badge bg-info ms-1">${overtime}</span>`;
            } else if (currentStatus === 'halfday') {
                statusText = 'H';
                statusClass = 'text-warning fw-bold';
            } else if (currentStatus === 'absent') {
                statusText = 'A';
                statusClass = 'text-danger fw-bold';
            } else {
                statusText = '-';
                statusClass = 'text-secondary';
            }
            
            return `
                <td class="text-center">
                    <span class="${statusClass}" style="font-size: 0.9rem;">${statusText}</span>
                    ${otIcon}
                </td>
            `;
        }).join('');
        
        const totals = calculateEmployeeTotals(employee.id);
        
        return `
            <tr data-employee-id="${employee.id}">
                <td>${escapeHtml(employee.employeeName || 'Unnamed')}</td>
                <td>${escapeHtml(employee.designation || 'N/A')}</td>
                <td class="text-end">₹${formatCurrency(salary)}</td>
                ${dateColumns}
                <td class="text-center">
                    <span id="presentDays_${employee.id}">${totals.presentDays.toFixed(1)}</span>
                </td>
                <td class="text-center">
                    <span id="otCount_${employee.id}">${totals.otCount}</span>
                </td>
                <td class="text-end">
                    <span class="text-info">₹<span id="otAmount_${employee.id}">${formatCurrency(totals.otAmount)}</span></span>
                </td>
                <td class="text-end">
                    <span class="fw-bold text-success">₹<span id="paymentAmount_${employee.id}">${formatCurrency(totals.payment)}</span></span>
                </td>
                <td>
                    <span class="badge bg-secondary" id="status_${employee.id}">
                        Not Calculated
                    </span>
                </td>
            </tr>
        `;
    }

    // Calculate employee totals including overtime
    function calculateEmployeeTotals(employeeId) {
        let totalDays = 0;
        let presentDays = 0;
        let absentDays = 0;
        let halfDays = 0;
        let otCount = 0;
        let otAmount = 0;
        let otDetails = {
            full: 0,
            half: 0,
            quarter: 0
        };
        
        const employee = employees.find(e => e.id === employeeId);
        const salary = employee?.salaryAmount || 0;
        
        dateRange.forEach(date => {
            const attendance = attendanceData[date]?.[employeeId];
            if (attendance) {
                if (attendance.status === 'present') {
                    totalDays += 1;
                    presentDays += 1;
                } else if (attendance.status.startsWith('present+')) {
                    const overtime = attendance.status.split('+')[1];
                    totalDays += 1;
                    presentDays += 1;
                    
                    // Count overtime
                    if (overtime === 'full') {
                        otDetails.full += 1;
                        otCount += 1;
                        otAmount += calculateOvertimeAmount(employee, 'full');
                    } else if (overtime === 'half') {
                        otDetails.half += 1;
                        otCount += 1;
                        otAmount += calculateOvertimeAmount(employee, 'half');
                    } else if (overtime === 'quarter') {
                        otDetails.quarter += 1;
                        otCount += 1;
                        otAmount += calculateOvertimeAmount(employee, 'quarter');
                    }
                } else if (attendance.status === 'halfday') {
                    if (halfDayAsFullDay) {
                        totalDays += 1;
                    } else {
                        totalDays += 0.5;
                    }
                    halfDays += 1;
                } else if (attendance.status === 'absent') {
                    absentDays += 1;
                }
            } else {
                if (autoMarkUnmarked) {
                    absentDays += 1;
                }
            }
        });
        
        const basePayment = totalDays * salary;
        const totalPayment = basePayment + otAmount;
        
        return {
            totalDays: totalDays,
            presentDays: presentDays,
            absentDays: absentDays,
            halfDays: halfDays,
            otCount: otCount,
            otAmount: otAmount,
            otDetails: otDetails,
            payment: totalPayment,
            basePayment: basePayment
        };
    }

    // Update employee totals in table
    function updateEmployeeTotals(employeeId) {
        const totals = calculateEmployeeTotals(employeeId);
        
        document.getElementById(`presentDays_${employeeId}`).textContent = totals.presentDays.toFixed(1);
        document.getElementById(`otCount_${employeeId}`).textContent = totals.otCount;
        document.getElementById(`otAmount_${employeeId}`).textContent = formatCurrency(totals.otAmount);
        document.getElementById(`paymentAmount_${employeeId}`).textContent = formatCurrency(totals.payment);
        
        const statusBadge = document.getElementById(`status_${employeeId}`);
        if (totals.presentDays > 0 || totals.otCount > 0) {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = 'Pending';
        } else {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = 'Not Calculated';
        }
        
        updateSummaryCards();
    }

    function updateAllEmployeeTotals() {
        employees.forEach(employee => {
            updateEmployeeTotals(employee.id);
        });
    }

    function updateSummaryCards() {
        let totalEmployees = employees.length;
        let totalPresentDays = 0;
        let totalAbsentDays = 0;
        let totalPayment = 0;
        let totalOTAmount = 0;
        let fullOTCount = 0;
        let halfOTCount = 0;
        let quarterOTCount = 0;
        
        employees.forEach(employee => {
            const totals = calculateEmployeeTotals(employee.id);
            totalPresentDays += totals.presentDays;
            totalAbsentDays += totals.absentDays;
            totalPayment += totals.payment;
            totalOTAmount += totals.otAmount;
            fullOTCount += totals.otDetails.full;
            halfOTCount += totals.otDetails.half;
            quarterOTCount += totals.otDetails.quarter;
        });
        
        document.getElementById('totalEmployeesCount').textContent = totalEmployees;
        document.getElementById('totalPresentDays').textContent = totalPresentDays.toFixed(1);
        document.getElementById('totalAbsentDays').textContent = totalAbsentDays;
        document.getElementById('totalPaymentAmount').textContent = '₹' + formatCurrency(totalPayment);
        
        document.getElementById('fullOTCount').textContent = fullOTCount;
        document.getElementById('halfOTCount').textContent = halfOTCount;
        document.getElementById('quarterOTCount').textContent = quarterOTCount;
        document.getElementById('totalOTAmount').textContent = '₹' + formatCurrency(totalOTAmount);
    }

    // Calculate payment for all employees
    function calculatePayment() {
        try {
            let allCalculated = true;
            
            employees.forEach(employee => {
                const totals = calculateEmployeeTotals(employee.id);
                
                const statusBadge = document.getElementById(`status_${employee.id}`);
                if (totals.presentDays > 0 || totals.otCount > 0) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Calculated';
                } else if (totals.absentDays > 0) {
                    statusBadge.className = 'badge bg-info';
                    statusBadge.textContent = 'Absent';
                } else {
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.textContent = 'No Data';
                    allCalculated = false;
                }
                
                paymentData[employee.id] = {
                    employeeName: employee.employeeName,
                    designation: employee.designation,
                    salary: employee.salaryAmount,
                    totalDays: totals.totalDays,
                    presentDays: totals.presentDays,
                    halfDays: totals.halfDays,
                    absentDays: totals.absentDays,
                    otCount: totals.otCount,
                    otAmount: totals.otAmount,
                    otDetails: totals.otDetails,
                    payment: totals.payment,
                    calculationDate: new Date().toISOString()
                };
            });
            
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('pdfBtn').disabled = false;
            document.getElementById('pdfBtn2').disabled = false;
            document.getElementById('addExpenseBtn').disabled = false;
            
            showNotification('Payment calculation completed successfully!', 'success');
            
        } catch (error) {
            console.error("Error calculating payment:", error);
            showNotification('Error calculating payment: ' + error.message, 'danger');
        }
    }

    // Download PDF with overtime details
// Download PDF with specific format
function downloadPDF() {
    if (employees.length === 0) {
        alert('No data to export.');
        return;
    }

    // Load logo first
    const img = new Image();
    img.src = 'img/logo.png';
    img.crossOrigin = 'anonymous';

    img.onload = function () {
        // Convert image to Base64 using canvas
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.getContext('2d').drawImage(img, 0, 0);

        const logoBase64 = canvas.toDataURL('image/png');

        // Generate PDF after logo is ready
        generatePDF(logoBase64);
    };

    img.onerror = function () {
        alert('Logo not found. Check img/tab-logo.png path.');
    };
}

function generatePDF(logoBase64) {
    try {

        const projectName = allProjects.find(p => p.id === selectedProjectId)?.name || 'Project';

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const leftMargin = 20;
        const rightMargin = 20;

        // ================= LOGO =================
        doc.addImage(logoBase64, 'PNG', leftMargin, 10, 40, 15);

        // ================= HEADER =================
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text('Barman Construction', pageWidth / 2, 15, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text('Employee Payment Report', pageWidth / 2, 22, { align: 'center' });

        // ================= INFO SECTION =================
        const startY = 35;

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');

        doc.text(`Project: ${projectName}`, leftMargin, startY);
        doc.text(
            `Period: ${formatDate(fromDate)} to ${formatDate(toDate)}`,
            leftMargin,
            startY + 6
        );

        doc.text(
            `Employee Type: ${
                selectedEmployeeType === 'daily'
                    ? 'Daily Worker'
                    : 'Contract Basis'
            }`,
            leftMargin,
            startY + 12
        );

        doc.text(
            `Generated On: ${new Date().toLocaleDateString()}`,
            pageWidth - rightMargin,
            startY + 12,
            { align: 'right' }
        );

        // Header Line (Same Alignment as Table)
        doc.line(leftMargin, startY + 15, pageWidth - rightMargin, startY + 15);

        // ================= TABLE DATA =================

        let totalPayment = 0;
        let totalDaysWorked = 0;
        let totalOTAmount = 0;
        let totalOTCount = 0;

        const totalDaysInPeriod = dateRange.length;

        const tableData = employees.map(emp => {

            const totals = calculateEmployeeTotals(emp.id);

            totalPayment += totals.payment;
            totalDaysWorked += totals.totalDays;
            totalOTAmount += totals.otAmount;
            totalOTCount += totals.otCount;

            return [
                emp.employeeName || 'Unnamed',
                `Rs. ${formatCurrency(emp.salaryAmount || 0)}`,
                totalDaysInPeriod.toString(),
                totals.totalDays.toFixed(1),
                totals.otCount.toString(),
                `Rs. ${formatCurrency(totals.otAmount)}`,
                `Rs. ${formatCurrency(totals.payment)}`,
                ''
            ];
        });

        // TOTAL ROW
        tableData.push([
            { content: 'TOTAL', styles: { fontStyle: 'bold' } },
            '',
            '',
            { content: totalDaysWorked.toFixed(1), styles: { fontStyle: 'bold' } },
            { content: totalOTCount.toString(), styles: { fontStyle: 'bold' } },
            { content: `Rs. ${formatCurrency(totalOTAmount)}`, styles: { fontStyle: 'bold' } },
            { content: `Rs. ${formatCurrency(totalPayment)}`, styles: { fontStyle: 'bold' } },
            ''
        ]);

        // ================= TABLE =================

        doc.autoTable({
            startY: startY + 20,

            head: [[
                'Employee Name',
                'Salary/Day',
                'Total Days',
                'Present Days',
                'OT Count',
                'OT Amount',
                'Total Payment',
                'Signature'
            ]],

            body: tableData,
            theme: 'grid',

            margin: { left: leftMargin, right: rightMargin },
            tableWidth: 'auto',

            styles: {
                fontSize: 9,
                lineWidth: 0.3,
                lineColor: [0, 0, 0],
                textColor: 0,
                cellPadding: 2
            },

            headStyles: {
                fillColor: [255, 255, 255],
                textColor: 0,
                fontStyle: 'bold'
            },

            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'center' },
                3: { halign: 'center' },
                4: { halign: 'center' },
                5: { halign: 'right' },
                6: { halign: 'right' },
                7: { halign: 'center' }
            },

            didDrawPage: function () {

                // Footer Line
                doc.line(
                    leftMargin,
                    pageHeight - 18,
                    pageWidth - rightMargin,
                    pageHeight - 18
                );

                // Footer Text
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(
                    'Generated by Barman Construction Software',
                    pageWidth / 2,
                    pageHeight - 14,
                    { align: 'center' }
                );

                doc.text(
                    `Page ${doc.internal.getNumberOfPages()}`,
                    pageWidth / 2,
                    pageHeight - 8,
                    { align: 'center' }
                );
            }
        });

        // ================= NOTES SECTION =================

        const finalY = doc.lastAutoTable.finalY + 10;

        doc.setFontSize(9);

        doc.setFont('helvetica', 'bold');
        doc.text(
            `* Total Employees: ${employees.length} Employees in the selected period`,
            leftMargin,
            finalY
        );

        doc.setFont('helvetica', 'normal');

        let presentDaysNote =
            `* Present Days: actual days worked (half days count as ${
                halfDayAsFullDay ? '1.0' : '0.5'
            } days)`;

        if (totalOTCount > 0) {
            presentDaysNote +=
                ` | Overtime: Full ${
                    overtimeSettings.rateType === 'percentage'
                        ? overtimeSettings.percentage.full + '%'
                        : '₹' + overtimeSettings.fixed.full
                }, Half ${
                    overtimeSettings.rateType === 'percentage'
                        ? overtimeSettings.percentage.half + '%'
                        : '₹' + overtimeSettings.fixed.half
                }, Quarter ${
                    overtimeSettings.rateType === 'percentage'
                        ? overtimeSettings.percentage.quarter + '%'
                        : '₹' + overtimeSettings.fixed.quarter
                }`;
        }

        doc.text(presentDaysNote, leftMargin, finalY + 5);

        doc.text(
            `* Total Days: ${totalDaysInPeriod} working days in the selected period`,
            leftMargin,
            finalY + 10
        );

        // ================= SAVE =================

        doc.save(
            `Payment_Report_${projectName}_${fromDate}_to_${toDate}.pdf`
        );

    } catch (err) {
        console.error(err);
        alert('PDF generation failed.');
    }
}
    async function saveDailyWorkerExpense(totalPayment) {
        try {
            if (!selectedProjectId) return;

            const today = new Date().toISOString().split('T')[0];

            const expenseData = {
                amount: totalPayment,
                date: today,
                remarks: `${formatDate(fromDate)} to ${formatDate(toDate)}`,
                title: "Payments Of Daily Worker",
                createdAt: new Date().toISOString(),
                createdBy: currentUser.uid
            };

            await database
                .ref(`projects/${selectedProjectId}/expenses`)
                .push(expenseData);

            console.log("✅ Expense saved successfully");
        } catch (error) {
            console.error("❌ Error saving expense:", error);
            alert("PDF downloaded but expense save failed!");
        }
    }

    async function addExpenseManually() {
        let totalPayment = 0;

        employees.forEach(employee => {
            const totals = calculateEmployeeTotals(employee.id);
            totalPayment += totals.payment;
        });

        if (totalPayment === 0) {
            alert("No payment amount to add.");
            return;
        }

        if (!confirm(`Add ₹${formatCurrency(totalPayment)} as Daily Worker Expense?`)) {
            return;
        }

        await saveDailyWorkerExpense(totalPayment);
        showNotification("Expense added successfully!", "success");
        document.getElementById('addExpenseBtn').disabled = true;
    }

    // Export to Excel with overtime
    function exportToExcel() {
        try {
            const exportData = [];
            
            const headerRow = [
                'Employee Name', 'Designation', 'Salary/Day', 
                ...dateRange, 
                'Present Days', 'OT Count', 'OT Amount (₹)', 'Total Payment (₹)', 'Status'
            ];
            exportData.push(headerRow);
            
            employees.forEach(employee => {
                const rowData = [
                    employee.employeeName || 'Unnamed',
                    employee.designation || 'N/A',
                    employee.salaryAmount || 0
                ];
                
                dateRange.forEach(date => {
                    const attendance = attendanceData[date]?.[employee.id];
                    let status = attendance?.status || (autoMarkUnmarked ? 'absent' : '');
                    
                    // Format status with overtime
                    if (status && status.startsWith('present+')) {
                        const ot = status.split('+')[1];
                        status = `P+${ot}`;
                    }
                    rowData.push(status);
                });
                
                const totals = calculateEmployeeTotals(employee.id);
                rowData.push(totals.presentDays.toFixed(1));
                rowData.push(totals.otCount);
                rowData.push(totals.otAmount);
                rowData.push(totals.payment);
                
                const statusBadge = document.getElementById(`status_${employee.id}`);
                rowData.push(statusBadge?.textContent || '');
                
                exportData.push(rowData);
            });
            
            const summaryRow = [
                '', '', 'TOTAL:', 
                ...Array(dateRange.length).fill(''), 
                '', '', '', '', ''
            ];
            let totalPayment = 0;
            let totalOTAmount = 0;
            employees.forEach(employee => {
                totalPayment += calculateEmployeeTotals(employee.id).payment;
                totalOTAmount += calculateEmployeeTotals(employee.id).otAmount;
            });
            summaryRow[summaryRow.length - 4] = totalOTAmount;
            summaryRow[summaryRow.length - 3] = totalPayment;
            exportData.push(summaryRow);
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            
            const wscols = [
                {wch: 20}, {wch: 15}, {wch: 12},
                ...dateRange.map(() => ({wch: 8})),
                {wch: 12}, {wch: 8}, {wch: 12}, {wch: 12}, {wch: 12}
            ];
            ws['!cols'] = wscols;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Payment Report');
            
            const projectName = allProjects.find(p => p.id === selectedProjectId)?.name || 'Project';
            const filename = `Payment_Report_${projectName}_${fromDate}_to_${toDate}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            showNotification('Excel file exported successfully!', 'success');
            
        } catch (error) {
            console.error("Error exporting to Excel:", error);
            showNotification('Error exporting to Excel: ' + error.message, 'danger');
        }
    }

    // Helper functions
    function formatCurrency(amount) {
        return parseFloat(amount).toLocaleString('en-IN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        notification.innerHTML = `
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            calculatePayment();
        }
    });
</script>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>